async function getData() {
    //let paths = await (await fetch("./src/paths.json")).json();
    //print(paths);
    return {"Lakeland": {"marks": ["Nariphon", "Nuckelavee"], "path": [[36.5, 20.8, 0.2, "Aetheryte", 0], [35.7, 27.05, 0.1, "Spawn", true, false, 15], [35.2, 32.2, 0.0, "Spawn", true, false, 18], [26.65, 37.2, 0.1, "Spawn", true, true, 19], [27.9, 30.9, 0.0, "Spawn", true, true, 17], [23.1, 29.7, 0.0, "Spawn", true, true, 16], [25.5, 23.9, 0.1, "Spawn", true, true, 13], [18.3, 23.0, 0.0, "Spawn", true, true, 12], [13.7, 24.5, 0.0, "Spawn", true, true, 14], [7.8, 22.75, 0.7, "Spawn", true, false, 11], [11.3, 17.25, 0.1, "Spawn", true, false, 8], [11.7, 12.65, 0.7, "Spawn", true, false, 5], [19.7, 9.75, 0.9, "Spawn", true, false, 2], [23.25, 12.35, 1.1, "Spawn", true, false, 4], [27.65, 15.35, 1.1, "Spawn", true, false, 6], [29.5, 19.3, 1.1, "Spawn", true, false, 9], [30.75, 22.65, 0.0, "Spawn", true, false, 10], [35.1, 15.95, 0.2, "Spawn", true, false, 7], [36.65, 12.2, 0.8, "Spawn", true, false, 3], [6.7, 16.8, 0.5, "Aetheryte", 1]]}, "Kholusia": {"marks": ["Huracan", "Li'l Murderer"], "path": [[34.8, 27.2, 0.2, "Aetheryte", 0], [34.45, 24.15, 0.4, "Spawn", false, true, 13], [26.8, 24.35, 0.3, "Spawn", false, true, 15], [30.05, 30.05, 0.1, "Spawn", false, true, 18], [24.7, 29.85, 0.1, "Spawn", false, true, 17], [20.9, 31.3, 0.1, "Spawn", false, true, 19], [15.0, 24.3, 0.5, "Spawn", false, true, 14], [9.0, 25.6, 0.5, "Spawn", false, true, 16], [16.5, 29.1, 0.1, "Aetheryte", 1], [12.9, 9.0, 4.1, "Aetheryte", 2], [17.05, 6.9, 4.6, "Spawn", true, true, 3], [19.6, 10.6, 4.1, "Spawn", true, true, 4], [24.8, 11.4, 3.3, "Spawn", true, true, 5], [21.8, 14.05, 3.5, "Spawn", true, true, 6], [14.9, 15.75, 3.6, "Spawn", true, true, 7], [11.6, 18.7, 3.4, "Spawn", true, true, 9], [21.2, 22.5, 3.2, "Spawn", true, true, 12], [22.95, 17.55, 3.3, "Spawn", true, true, 8], [26.7, 19.25, 3.0, "Spawn", true, true, 10], [31.45, 19.65, 2.8, "Spawn", true, true, 11]]}, "Amh Araeng": {"marks": ["Sugaar", "Maliktender"], "path": [[26.4, 17.0, 1.2, "Aetheryte", 0], [29.4, 27.6, 0.9, "Aetheryte", 1], [28.5, 26.0, 0.7, "Spawn", true, true, 14], [33.55, 21.55, 0.8, "Spawn", true, true, 11], [28.8, 20.25, 0.9, "Spawn", true, true, 10], [30.95, 13.75, 0.7, "Spawn", true, true, 7], [28.6, 12.3, 0.8, "Spawn", true, true, 6], [22.6, 10.5, 1.6, "Spawn", true, false, 4], [19.35, 16.15, 1.5, "Spawn", true, false, 8], [16.7, 10.25, 1.5, "Spawn", true, false, 3], [10.25, 11.95, 1.1, "Spawn", true, false, 5], [11.55, 19.5, 1.4, "Spawn", true, false, 9], [16.3, 24.05, 1.2, "Spawn", true, false, 12], [19.2, 24.9, 0.8, "Spawn", true, false, 13], [19.75, 28.75, 0.5, "Spawn", true, false, 15], [17.15, 31.65, 0.5, "Spawn", true, false, 17], [19.9, 36.45, 0.6, "Spawn", true, true, 20], [23.2, 29.75, 0.0, "Spawn", true, true, 16], [30.4, 35.25, 0.2, "Spawn", true, true, 19], [33.0, 33.9, 0.1, "Spawn", true, true, 18], [11.2, 17.2, 1.6, "Aetheryte", 2]]}, "Il Mheg": {"marks": ["The Mudman", "O Poorest Pauldia"], "path": [[14.6, 31.7, 0.4, "Aetheryte", 0], [20.0, 4.2, 1.0, "Aetheryte", 1], [20.2, 8.5, 0.5, "Spawn", true, true, 6], [25.5, 7.1, 0.7, "Spawn", true, true, 4], [29.25, 5.45, 0.8, "Spawn", true, true, 3], [33.8, 7.3, 1.0, "Spawn", true, true, 5], [31.6, 13.65, 0.9, "Spawn", true, true, 7], [27.2, 19.0, 0.4, "Spawn", true, true, 9], [19.1, 27.15, 0.0, "Spawn", true, true, 13], [22.8, 28.85, 0.0, "Spawn", true, true, 14], [24.55, 32.75, 0.0, "Spawn", true, true, 16], [24.7, 37.25, 0.0, "Spawn", true, true, 19], [19.7, 34.9, 0.3, "Spawn", true, true, 18], [13.6, 34.1, 0.6, "Spawn", true, true, 17], [9.65, 30.65, 0.6, "Spawn", true, true, 15], [7.85, 27.05, 0.4, "Spawn", true, true, 12], [7.45, 23.0, 0.3, "Spawn", true, true, 11], [10.8, 20.35, 0.1, "Spawn", true, true, 10], [11.2, 15.9, 0.3, "Spawn", true, true, 8], [29.1, 7.7, 0.8, "Aetheryte", 2]]}, "The Rak'tika Greatwood": {"marks": ["Supay", "Grassman"], "path": [[19.4, 27.4, -0.2, "Aetheryte", 0], [16.7, 24.05, 0.1, "Spawn", true, true, 9], [14.9, 22.35, 0.0, "Spawn", true, true, 6], [9.5, 18.6, 0.2, "Spawn", true, true, 5], [9.9, 24.0, 0.0, "Spawn", true, true, 8], [15.1, 30.25, 0.1, "Spawn", true, true, 12], [8.5, 34.65, 0.0, "Spawn", true, true, 14], [12.05, 35.85, -0.1, "Spawn", true, true, 16], [17.8, 35.1, 0.1, "Spawn", true, true, 15], [25.3, 30.3, -0.2, "Spawn", true, true, 13], [26.3, 24.25, 0.1, "Spawn", true, true, 10], [29.7, 26.05, 0.3, "Spawn", true, true, 11], [33.35, 22.8, 0.2, "Spawn", true, true, 7], [26.35, 14.95, 0.0, "Spawn", true, false, 4], [21.95, 13.7, -0.1, "Spawn", true, false, 3], [22.5, 10.75, -0.2, "Spawn", true, false, 2], [29.1, 17.5, 0.2, "Aetheryte", 1]]}, "The Tempest": {"marks": ["Baal", "Rusalka"], "path": [[32.7, 17.5, -2.0, "Aetheryte", 0], [36.6, 11.55, -1.4, "Spawn", true, true, 9], [37.75, 16.7, -1.6, "Spawn", true, true, 12], [36.1, 19.95, -1.5, "Spawn", true, true, 14], [33.7, 21.6, -1.7, "Spawn", true, true, 16], [29.1, 22.85, -2.1, "Spawn", true, true, 17], [24.7, 24.7, -2.7, "Spawn", true, true, 18], [15.4, 20.4, -2.8, "Spawn", true, true, 15], [13.45, 17.4, -4.3, "Spawn", true, true, 13], [8.35, 8.35, -1.5, "Spawn", true, true, 5], [11.4, 5.25, -1.6, "Spawn", true, true, 3], [15.7, 10.3, -1.7, "Spawn", true, true, 7], [18.2, 13.35, -1.9, "Spawn", true, true, 11], [21.0, 7.7, -1.3, "Spawn", true, true, 4], [25.3, 12.95, -1.9, "Spawn", true, true, 10], [30.75, 10.95, -1.7, "Spawn", true, true, 8], [28.4, 8.45, -1.8, "Spawn", true, true, 6], [31.2, 4.05, -1.1, "Spawn", true, true, 2], [18.5, 25.8, -8.3, "Aetheryte", 1]]}};
}

function loadTemplate(templateId) {
    let template = document.getElementById(templateId);
    return template.content.cloneNode(true);
}

function translateName(zone) {
    return zone.replace(/ /g, "_").replace(/\'/g, "_").toLowerCase();
}

function generateZoneHeader(zone) {
    let node = loadTemplate("zone-header-template");
    let div = node.querySelector(".zone-header");
    div.textContent = zone;
    div.classList.add(translateName(zone));
    return node;
}

async function loadImage(src) {
    let loader = src => new Promise(resolve => {
        let img = new Image();
        img.onload = () => resolve(img);
        img.src = src;
    });
    return await loader(src);
}

async function mapImage(zone) {
    return await loadImage(`img/${translateName(zone)}.jpg`);
}

function getMapSize() {
    return Math.min(640, Math.floor(Math.min(window.innerHeight, window.innerWidth) - 16));
}

async function generateMap(zone, contents) {
    let path = contents["path"];

    let node = loadTemplate("map-container-template");
    let div = node.querySelector(".map-container");
    div.classList.add(translateName(zone));
    let name = node.querySelector(".map-name");
    name.textContent = zone;

    let markAName = node.querySelector(".mark-name.mark-a");
    markAName.textContent = contents["marks"][0];
    let markBName = node.querySelector(".mark-name.mark-b");
    markBName.textContent = contents["marks"][1];

    let canvas = node.querySelector(".map-canvas");
    let size = getMapSize();
    console.log(size);
    canvas.width = size;
    canvas.height = size;

    let context = canvas.getContext("2d");
    context.scale(canvas.width/41.0, canvas.height/41.0);
    context.translate(-1, -1);

    let bg = await mapImage(zone);
    context.drawImage(bg, 1, 1, 41, 41);

    context.beginPath();
    context.lineWidth = 0.4;
    path.forEach(point => {
        if (point[3] === "Aetheryte") {
            context.moveTo(point[0], point[1]);        
        } else {
            context.lineTo(point[0], point[1]);
        }
    });
    context.stroke();
    context.closePath();

    path.forEach(point => {
        if (point[3] === "Aetheryte") {
            context.beginPath();
            context.fillStyle = "cyan";
            context.ellipse(point[0], point[1], 0.5, 0.5, 0, 0, 2*Math.PI);
            context.fill();
            context.closePath();
        } else {
            if (point[4] && point[5]) {
                context.beginPath();
                context.fillStyle = "red";
                context.ellipse(point[0], point[1], 0.5, 0.5, Math.PI / 2.0, 0, 2*Math.PI);
                context.fill();
                context.closePath();
                context.beginPath();
                context.fillStyle = "orange";
                context.ellipse(point[0], point[1], 0.5, 0.5, Math.PI / 2.0, Math.PI, 2*Math.PI);
                context.fill();
                context.closePath();
            } else if (point[4] && !point[5]) {
                context.beginPath();
                context.fillStyle = "red";
                context.ellipse(point[0], point[1], 0.5, 0.5, Math.PI / 2.0, 0, 2*Math.PI);
                context.fill();
                context.closePath();
            } else if (!point[4] && point[5]) {
                context.beginPath();
                context.fillStyle = "orange";
                context.ellipse(point[0], point[1], 0.5, 0.5, Math.PI / 2.0, 0, 2*Math.PI);
                context.fill();
                context.closePath();
            }
        }
    });

    toggleMapContainer(div, false);
    return node;
}

async function populateData(data, zoneHeaderContainer, mapsContainer) {
    for (const [zone, contents] of Object.entries(data)) {
        let headerNode = generateZoneHeader(zone);
        zoneHeaderContainer.append(headerNode);
        let mapNode = await generateMap(zone, contents);
        mapsContainer.append(mapNode);
    }
}

function toggleMapContainer(container, toggle) {
    container.style.display = toggle ? "block" : "none";
}

function toggleZoneHeaderContainer(container, toggle) {
    container.classList.toggle("active", toggle);
}

function setControls(zoneHeaderContainer, mapsContainer) {
    let mapContainers = mapsContainer.querySelectorAll(".map-container");
    let zoneHeaderContainers = zoneHeaderContainer.querySelectorAll(".zone-header");
    zoneHeaderContainers.forEach(zoneHeaderContainer => {
        let zone = zoneHeaderContainer.classList[1];
        let mapContainer = mapsContainer.querySelector(`.${zone}`);
        zoneHeaderContainer.addEventListener("click", () => {
            mapContainers.forEach(container => toggleMapContainer(container, container == mapContainer));
            zoneHeaderContainers.forEach(container => toggleZoneHeaderContainer(container, container == zoneHeaderContainer));
        });
    });
}

async function run() {
    let zoneHeaderContainer = document.getElementById("zone-header-container");
    let mapsContainer = document.getElementById("maps-container");

    let data = await getData();
    await populateData(data, zoneHeaderContainer, mapsContainer);
    setControls(zoneHeaderContainer, mapsContainer);
    toggleZoneHeaderContainer(zoneHeaderContainer.querySelector(".zone-header"), true);
    toggleMapContainer(mapsContainer.querySelector(".map-container"), true);
}

window.onload = run;